<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Back Office - Refund Management</title>
  </head>
  <body>
    <h1>Back Office - Refund Management</h1>
    <p>Enter the Capture ID (Transaction ID) to process a refund.</p>

    <div>
      <label for="capture-id">Capture ID</label><br />
      <input
        type="text"
        id="capture-id"
        placeholder="e.g., 3C679366HH908993F"
        size="40"
      />
    </div>

    <br />

    <div>
      <label for="refund-amount"
        >Refund Amount (leave empty for full refund)</label
      ><br />
      <input
        type="number"
        id="refund-amount"
        placeholder="e.g., 50.00"
        step="0.01"
      />
    </div>

    <br />

    <button onclick="processRefund('full')">Full Refund</button>
    <button onclick="processRefund('partial')">Partial Refund</button>

    <div id="result"></div>

    <script>
      async function processRefund(type) {
        const captureId = document.getElementById("capture-id").value;
        const amountInput = document.getElementById("refund-amount").value;
        const resultDiv = document.getElementById("result");

        if (!captureId) {
          resultDiv.innerHTML =
            "<p style='color:red;'>Please enter a Capture ID</p>";
          return;
        }

        if (type === "partial" && !amountInput) {
          resultDiv.innerHTML =
            "<p style='color:red;'>Please enter an amount for partial refund</p>";
          return;
        }

        resultDiv.innerHTML = "<p>Processing refund...</p>";

        try {
          const body = {};
          if (type === "partial" && amountInput) {
            body.amount = amountInput;
          }

          const response = await fetch(`/api/orders/${captureId}/refund`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          const data = await response.json();
          console.log("Refund response:", data);

          if (data.id) {
            resultDiv.innerHTML = `
              <h3 style="color:green;">Refund Successful</h3>
              <p><strong>Refund ID:</strong> ${data.id}</p>
              <p><strong>Status:</strong> ${data.status}</p>
              <p><strong>Amount:</strong> ${
                data.amount?.currency_code || "USD"
              } ${data.amount?.value || "Full"}</p>
            `;
          } else {
            resultDiv.innerHTML = `
              <h3 style="color:red;">Refund Failed</h3>
              <p>${data.message || data.error || JSON.stringify(data)}</p>
            `;
          }
        } catch (error) {
          console.error("Error:", error);
          resultDiv.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
        }
      }
    </script>
  </body>
</html>
